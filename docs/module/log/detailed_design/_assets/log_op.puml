@startuml log_op

participant "User" as actor

box "mw_log" #LightBlue
participant "log!" as log_macro
participant "logger()" as logger_fn
participant "__private_api::module_path()" as module_path_fn
participant "max_level()" as max_level_fn
end box

box "mw_log_macro" #LightGreen
participant "mw_log_format_args!" as mw_log_format_args
end box

box "mw_log_subscriber" #LightPink
participant "Log impl" as logger
participant "ScoreWrite impl" as writer
end box

box "mw_log_fmt" #LightYellow
participant "write" as write_fn
participant "ScoreDisplay::fmt" as fmt_display
participant "ScoreDebug::fmt" as fmt_debug
end box

actor -> log_macro : Log message with log level

alt no-user-provided-logger
    log_macro -> logger_fn : Get global logger
    logger_fn --> log_macro : Logger
end

alt no-user-provided-context
    log_macro -> module_path_fn : Get module path as context
    module_path_fn --> log_macro : Module path
end

log_macro -> max_level_fn : Get max log level
max_level_fn --> log_macro : Max log level

alt log-level-check-failed
    log_macro --> actor : Do not log, return control to caller

else log-level-check-passed
    log_macro -> mw_log_format_args : Process format string and arguments
    mw_log_format_args --> log_macro : Processed arguments

    log_macro -> logger : Log processed arguments

    logger -> logger : Check if logger enabled

    alt logger-not-enabled
        logger --> log_macro

    else logger-enabled
        logger -> writer : Get writer instance
        writer --> logger : Writer instance

        logger -> write_fn : Write arguments to given writer

        loop process-format-string-fragments
            alt is-literal
                write_fn -> writer : Write string
                writer --> write_fn
            else is-placeholder
                alt display-requested
                    write_fn -> fmt_display : Process Display placeholder
                    fmt_display --> write_fn : Processed placeholder
                else debug-requested
                    write_fn -> fmt_debug : Processed Debug placeholder
                    fmt_debug --> write_fn : Processed placeholder
                end
                write_fn -> writer : Write placeholder data
                writer --> write_fn
            end
        end

        write_fn --> logger
        logger --> log_macro
    end
end

log_macro --> actor

@enduml
